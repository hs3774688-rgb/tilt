<!DOCTYPE html>
<html>
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/addons/p5.dom.min.js"></script> <!-- For buttons -->
</head>
<body>
  <script>


// Device Tilt Tester - Optimized with Permission Logic
let tiltValue = 0;
let smoothTilt = 0;
let xPos, yPos;

function setup() {
  createCanvas(windowWidth, windowHeight);
  xPos = width / 2;
  yPos = height * 0.6;
  
  // Call the permission handler immediately
  startDeviceRotationDetect();
  
  textAlign(CENTER, CENTER);
}

function startDeviceRotationDetect() {
  // Check if we are on iOS 13+ which requires manual permission
  if (typeof(DeviceMotionEvent) !== "undefined" && typeof(DeviceMotionEvent.requestPermission) === "function") {
    
    let button = createButton('Allow Tilt Sensors');
    button.style('font-size', '24px');
    button.position(width / 2 - 100, height / 2);
    
    button.mousePressed(() => {
      DeviceMotionEvent.requestPermission()
        .then(response => {
          if (response == 'granted') {
            button.hide(); // Hide button once permission is given
          }
        })
        .catch(console.error);
    });
  }
}

function draw() {
  background(135, 206, 250); 
  
  // 1. Update Tilt Logic
  // We check if rotationY exists. If it's undefined or 0 (and we aren't moving), we use keys.
  if (typeof rotationY !== 'undefined' && (rotationY !== 0 || rotationX !== 0)) {
    tiltValue = rotationY;
  } else {
    // Desktop simulation (A/D or Arrows)
    if (keyIsDown(LEFT_ARROW) || keyIsDown(65)) tiltValue = -45;
    else if (keyIsDown(RIGHT_ARROW) || keyIsDown(68)) tiltValue = 45;
    else tiltValue = 0;
  }

  // Smooth the movement (lerp)
  smoothTilt = lerp(smoothTilt, tiltValue, 0.1);

  // 2. Visuals
  drawEnvironment();
  drawLeaningBike(width / 2, yPos, smoothTilt);
  
  // 3. Data Overlay
  drawUI();
}

function drawEnvironment() {
  // Simple horizon
  fill(34, 139, 34);
  noStroke();
  rect(0, height * 0.65, width, height * 0.35);
}

function drawLeaningBike(x, y, tilt) {
  push();
  translate(x, y);
  // rotationY (Gamma) controls the left/right lean
  rotate(radians(tilt * 0.5)); 
  
  // Bike Body
  stroke(0);
  strokeWeight(2);
  fill(0, 0, 255);
  rect(-20, -10, 40, 15, 5);
  
  // Wheels
  fill(30);
  ellipse(-15, 10, 25);
  ellipse(15, 10, 25);
  
  // Handlebars
  line(10, -10, 15, -25);
  line(5, -25, 25, -25);
  pop();
}

function drawUI() {
  fill(255);
  textSize(40);
  text(floor(smoothTilt) + "Â°", width / 2, height * 0.85);
  
  textSize(16);
  fill(0, 100);
  let mode = (typeof rotationY !== 'undefined' && rotationY !== 0) ? "SENSOR ACTIVE" : "KEYBOARD SIM";
  text("MODE: " + mode, width / 2, 30);
  
  if (mode === "KEYBOARD SIM") {
    text("Use A / D keys to test", width/2, 55);
  }
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
}
 </script>
</body>
</html>


