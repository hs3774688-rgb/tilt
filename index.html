<!DOCTYPE html>
<html>
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/addons/p5.dom.min.js"></script> <!-- For buttons -->
</head>
<body>
  <script>

/**
 * 1701ITC Assessment 2 - City Cycler (Milestones 1 & 2)
 * Features:
 * - Bicycle with Rider: Detailed player avatar.
 * - Road Environment: Scrolling lanes and grass shoulders.
 * - Tilt/Keyboard Control: Mobile accelerometer with desktop fallback.
 * - Sound: Continuous loop of song.mp3.
 * - State Flow: Title -> Instructions -> Playing -> GameOver.
 */

let gameState = 'TITLE'; 
let player;
let obstacles = [];
let score = 0;
let highScore = 0;
let gameSpeed = 5; 
let bgOffset = 0; 
let bgSong;
let permissionGranted = false;
let permissionButton;

function preload() {
  soundFormats('mp3', 'ogg');
  // Ensure song.mp3 is in your project folder
  bgSong = loadSound('song.mp3');
}

function setup() {
  createCanvas(windowWidth, windowHeight);
  rectMode(CENTER);
  textAlign(CENTER, CENTER);
  player = new Player();

  // Mobile Sensor Permission
  if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
    permissionButton = createButton('Enable Tilt Sensors');
    permissionButton.position(width / 2 - 75, height / 2 + 100);
    permissionButton.style('padding', '10px');
    permissionButton.style('border-radius', '5px');
    permissionButton.mousePressed(requestSensorPermission);
  } else {
    permissionGranted = true;
  }
}

function draw() {
  drawRoad(); 

  switch (gameState) {
    case 'TITLE':
      drawTitleScreen();
      break;
    case 'INSTRUCTIONS':
      drawInstructionScreen();
      break;
    case 'PLAYING':
      playGame();
      break;
    case 'GAMEOVER':
      drawGameOverScreen();
      break;
  }
}

// --- Environment ---

function drawRoad() {
  background(60); // Asphalt
  
  // Grass shoulders
  noStroke();
  fill(34, 139, 34); 
  rect(width/2, 25, width, 50);
  rect(width/2, height - 25, width, 50);

  // Moving Lane Lines
  stroke(255);
  strokeWeight(4);
  bgOffset -= gameSpeed;
  if (bgOffset < -100) bgOffset = 0;

  for (let x = bgOffset; x < width; x += 100) {
    line(x + 20, height / 2, x + 70, height / 2); 
  }
}

// --- Game State Screens ---

function drawTitleScreen() {
  fill(0, 0, 0, 150);
  rect(width/2, height/2, width, height); 
  fill(255, 204, 0);
  textSize(50);
  text("CITY CYCLER", width / 2, height / 2 - 50);
  textSize(20);
  fill(255);
  text("Safety First! Avoid the Cones.", width / 2, height / 2);
  fill(0, 255, 150);
  text("Tap to Start", width / 2, height / 2 + 60);
}

function drawInstructionScreen() {
  fill(0, 0, 0, 180);
  rect(width/2, height/2, width, height);
  fill(255);
  textSize(24);
  text("RIDER INSTRUCTIONS", width / 2, height / 3);
  textSize(18);
  text("Tilt your phone to steer.\nOn Laptop: Use Arrow Keys.\nDon't hit the traffic cones!", width / 2, height / 2);
  fill(0, 255, 150);
  text("Tap to Ride", width / 2, height / 2 + 120);
}

function playGame() {
  handleInput();
  player.update();
  player.display();

  // Spawn obstacles
  if (frameCount % 50 === 0) { 
    obstacles.push(new Obstacle());
  }

  // Update obstacles
  for (let i = obstacles.length - 1; i >= 0; i--) {
    obstacles[i].update();
    obstacles[i].display();

    if (obstacles[i].hits(player)) endGame();

    if (obstacles[i].offscreen()) {
      obstacles.splice(i, 1);
      score++;
      if (score % 10 === 0) gameSpeed += 0.5; // Difficulty scaling
    }
  }
  drawHUD();
}

function drawGameOverScreen() {
  fill(0, 0, 0, 200);
  rect(width/2, height/2, width, height);
  fill(255, 50, 50);
  textSize(48);
  text("WIPE OUT!", width / 2, height / 2 - 60);
  fill(255);
  textSize(24);
  text("Final Distance: " + score + "m", width / 2, height / 2);
  text("Session Record: " + highScore + "m", width / 2, height / 2 + 40);
  fill(0, 255, 150);
  text("Tap to Restart", width / 2, height / 2 + 100);
}

// --- Interaction & Controls ---

function drawHUD() {
  fill(255, 255, 0);
  noStroke();
  textSize(22);
  textAlign(LEFT);
  text("Distance: " + score + "m", 30, 50);
  textAlign(RIGHT);
  text("Best: " + highScore + "m", width - 30, 50);
  textAlign(CENTER);
}

function handleInput() {
  if (permissionGranted) {
    let tiltX = constrain(rotationY, -25, 25); 
    let tiltY = constrain(rotationX, -25, 25);
    player.applyForce(tiltX * 0.12, tiltY * 0.12);
  }
  if (keyIsDown(LEFT_ARROW)) player.applyForce(-0.6, 0);
  if (keyIsDown(RIGHT_ARROW)) player.applyForce(0.6, 0);
  if (keyIsDown(UP_ARROW)) player.applyForce(0, -0.6);
  if (keyIsDown(DOWN_ARROW)) player.applyForce(0, 0.6);
}

function mousePressed() {
  if (gameState === 'TITLE') {
    gameState = 'INSTRUCTIONS';
    if (!bgSong.isPlaying()) { bgSong.loop(); bgSong.setVolume(0.4); }
  } else if (gameState === 'INSTRUCTIONS' || gameState === 'GAMEOVER') {
    resetGame();
    gameState = 'PLAYING';
  }
}

function resetGame() {
  score = 0;
  gameSpeed = 5;
  obstacles = [];
  player = new Player();
}

function endGame() {
  gameState = 'GAMEOVER';
  if (score > highScore) highScore = score;
}

function requestSensorPermission() {
  DeviceOrientationEvent.requestPermission()
    .then(response => {
      if (response === 'granted') {
        permissionGranted = true;
        permissionButton.remove();
      }
    }).catch(console.error);
}

// --- Classes ---

class Player {
  constructor() {
    this.x = 150;
    this.y = height / 2;
    this.vx = 0;
    this.vy = 0;
    this.friction = 0.94;
  }

  applyForce(fx, fy) {
    this.vx += fx;
    this.vy += fy;
  }

  update() {
    this.x += this.vx;
    this.y += this.vy;
    this.vx *= this.friction;
    this.vy *= this.friction;
    this.x = constrain(this.x, 30, width - 30);
    this.y = constrain(this.y, 70, height - 70); 
  }

  display() {
    push();
    translate(this.x, this.y);
    
    // --- DRAW BICYCLE ---
    stroke(0);
    strokeWeight(3);
    fill(40);
    ellipse(-18, 15, 22, 22); // Back wheel
    ellipse(18, 15, 22, 22);  // Front wheel
    
    // Bike Frame
    stroke(0, 150, 255); 
    strokeWeight(4);
    line(-18, 15, 0, 0);    // Rear to seat
    line(0, 0, 18, 15);     // Seat to front
    line(18, 15, 12, -10);  // Fork
    
    // --- DRAW RIDER ---
    // Torso
    stroke(255, 200, 0); // Yellow jersey
    strokeWeight(8);
    line(0, 0, 5, -15);
    
    // Arms reaching for handlebars
    stroke(255, 224, 189); // Skin tone
    strokeWeight(3);
    line(5, -12, 12, -10);
    
    // Head & Helmet
    fill(255, 224, 189);
    noStroke();
    ellipse(8, -25, 12, 12); // Head
    fill(255, 50, 50); // Red helmet
    arc(8, -28, 15, 12, PI, TWO_PI); 
    
    // Handlebars
    stroke(0);
    strokeWeight(4);
    line(10, -10, 18, -10);
    pop();
  }
}

class Obstacle {
  constructor() {
    this.w = 30;
    this.h = 40;
    this.x = width + this.w;
    this.y = random(80, height - 80);
  }

  update() {
    this.x -= gameSpeed;
  }

  display() {
    push();
    translate(this.x, this.y);
    noStroke();
    fill(255, 100, 0); // Orange Cone
    triangle(-15, 20, 15, 20, 0, -20);
    fill(255); // White stripe
    rect(0, 0, 12, 6);
    fill(50); // Base
    rect(0, 20, 35, 6);
    pop();
  }

  hits(p) {
    // Collision box for rider and bike
    return (p.x + 20 > this.x - 15 &&
            p.x - 20 < this.x + 15 &&
            p.y + 25 > this.y - 20 &&
            p.y - 25 < this.y + 20);
  }

  offscreen() { return this.x < -100; }
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
}  
  
  </script>
</body>
</html>





